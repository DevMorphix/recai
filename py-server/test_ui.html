<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhisperX Test UI</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
            padding: 20px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            margin-bottom: 10px;
            font-size: 2rem;
        }
        .subtitle {
            text-align: center;
            color: #888;
            margin-bottom: 30px;
        }
        .status-bar {
            background: #0f3460;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-dot.online { background: #00ff88; }
        .status-dot.offline { background: #ff4444; }
        .card {
            background: #1f2937;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        .card h2 {
            margin-bottom: 20px;
            font-size: 1.3rem;
            color: #60a5fa;
        }
        .upload-area {
            border: 2px dashed #4b5563;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        .upload-area:hover {
            border-color: #60a5fa;
            background: rgba(96, 165, 250, 0.1);
        }
        .upload-area.dragover {
            border-color: #00ff88;
            background: rgba(0, 255, 136, 0.1);
        }
        input[type="file"] {
            display: none;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            margin: 5px;
        }
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
        }
        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }
        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        .options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .option-group label {
            display: block;
            margin-bottom: 5px;
            color: #9ca3af;
            font-size: 0.9rem;
        }
        .option-group select, .option-group input {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #4b5563;
            background: #374151;
            color: white;
            font-size: 1rem;
        }
        .result-box {
            background: #111827;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        .result-box pre {
            white-space: pre-wrap;
            word-break: break-word;
            font-family: 'Fira Code', monospace;
            font-size: 0.9rem;
        }
        .speaker-segment {
            padding: 10px 15px;
            margin: 8px 0;
            border-radius: 8px;
            border-left: 4px solid;
        }
        .speaker-0 { border-color: #3b82f6; background: rgba(59, 130, 246, 0.1); }
        .speaker-1 { border-color: #10b981; background: rgba(16, 185, 129, 0.1); }
        .speaker-2 { border-color: #f59e0b; background: rgba(245, 158, 11, 0.1); }
        .speaker-3 { border-color: #ef4444; background: rgba(239, 68, 68, 0.1); }
        .speaker-label {
            font-weight: bold;
            font-size: 0.85rem;
            margin-bottom: 5px;
        }
        .timestamp {
            color: #6b7280;
            font-size: 0.8rem;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 30px;
        }
        .loading.active {
            display: block;
        }
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #374151;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .file-info {
            background: #374151;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            display: none;
        }
        .file-info.active {
            display: block;
        }
        .record-btn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            font-size: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
        }
        .record-btn.recording {
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            50% { box-shadow: 0 0 0 20px rgba(239, 68, 68, 0); }
        }
        audio {
            width: 100%;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéôÔ∏è WhisperX Test UI</h1>
        <p class="subtitle">Test transcription and speaker diarization</p>

        <!-- Status Bar -->
        <div class="status-bar">
            <div>
                <span class="status-dot" id="statusDot"></span>
                <span id="statusText">Checking server...</span>
            </div>
            <div id="serverInfo"></div>
        </div>

        <!-- Upload/Record Card -->
        <div class="card">
            <h2>üìÅ Upload or Record Audio</h2>
            
            <div class="upload-area" id="dropZone" onclick="document.getElementById('fileInput').click()">
                <div style="font-size: 3rem; margin-bottom: 15px;">üì§</div>
                <p>Drop audio file here or click to browse</p>
                <p style="color: #6b7280; font-size: 0.9rem; margin-top: 10px;">Supports: WAV, MP3, M4A, WEBM, OGG</p>
            </div>
            <input type="file" id="fileInput" accept="audio/*">

            <div style="text-align: center; margin: 20px 0; color: #6b7280;">‚Äî OR ‚Äî</div>

            <div style="text-align: center;">
                <button class="btn btn-danger record-btn" id="recordBtn" onclick="toggleRecording()">üé§</button>
                <p id="recordStatus" style="margin-top: 10px; color: #9ca3af;">Click to start recording</p>
            </div>

            <audio id="audioPreview" controls style="display: none;"></audio>

            <div class="file-info" id="fileInfo">
                <strong>Selected File:</strong> <span id="fileName"></span><br>
                <strong>Size:</strong> <span id="fileSize"></span>
            </div>
        </div>

        <!-- Options Card -->
        <div class="card">
            <h2>‚öôÔ∏è Options</h2>
            <div class="options">
                <div class="option-group">
                    <label>Language</label>
                    <select id="language">
                        <option value="auto">Auto Detect</option>
                        <option value="en">English</option>
                        <option value="ml">Malayalam</option>
                        <option value="hi">Hindi</option>
                        <option value="ta">Tamil</option>
                        <option value="te">Telugu</option>
                        <option value="es">Spanish</option>
                        <option value="fr">French</option>
                        <option value="de">German</option>
                        <option value="zh">Chinese</option>
                        <option value="ja">Japanese</option>
                    </select>
                </div>
                <div class="option-group">
                    <label>Model Size</label>
                    <select id="modelSize">
                        <option value="base">Base (Fast)</option>
                        <option value="small">Small</option>
                        <option value="medium">Medium</option>
                        <option value="large-v3">Large-v3 (Best)</option>
                    </select>
                </div>
                <div class="option-group">
                    <label>Number of Speakers (optional)</label>
                    <input type="number" id="numSpeakers" min="1" max="10" placeholder="Auto detect">
                </div>
            </div>

            <div class="btn-group">
                <button class="btn btn-primary" onclick="transcribe()" id="transcribeBtn" disabled>
                    üìù Transcribe Only
                </button>
                <button class="btn btn-primary" onclick="diarize()" id="diarizeBtn" disabled>
                    üë• Diarize Only
                </button>
                <button class="btn btn-success" onclick="fullPipeline()" id="fullBtn" disabled>
                    üöÄ Full Pipeline (Transcribe + Speakers)
                </button>
            </div>
        </div>

        <!-- Results Card -->
        <div class="card">
            <h2>üìä Results</h2>
            
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p id="loadingText">Processing...</p>
            </div>

            <div class="result-box" id="resultBox" style="display: none;">
                <div id="resultContent"></div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5001';
        let audioFile = null;
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;

        // Check server status
        async function checkServer() {
            try {
                const res = await fetch(`${API_BASE}/health`);
                const data = await res.json();
                document.getElementById('statusDot').className = 'status-dot online';
                document.getElementById('statusText').textContent = 'Server Online';
                document.getElementById('serverInfo').textContent = `PyTorch ${data.torch_version} | GPU: ${data.gpu_available ? 'Yes' : 'No'}`;
            } catch (e) {
                document.getElementById('statusDot').className = 'status-dot offline';
                document.getElementById('statusText').textContent = 'Server Offline';
                document.getElementById('serverInfo').textContent = 'Start the Python server first';
            }
        }

        // File handling
        document.getElementById('fileInput').addEventListener('change', (e) => {
            handleFile(e.target.files[0]);
        });

        const dropZone = document.getElementById('dropZone');
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            handleFile(e.dataTransfer.files[0]);
        });

        function handleFile(file) {
            if (!file) return;
            audioFile = file;
            document.getElementById('fileInfo').classList.add('active');
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = formatBytes(file.size);
            
            // Preview
            const audio = document.getElementById('audioPreview');
            audio.src = URL.createObjectURL(file);
            audio.style.display = 'block';
            
            enableButtons();
        }

        function formatBytes(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        function enableButtons() {
            document.getElementById('transcribeBtn').disabled = false;
            document.getElementById('diarizeBtn').disabled = false;
            document.getElementById('fullBtn').disabled = false;
        }

        // Recording
        async function toggleRecording() {
            if (!isRecording) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];

                    mediaRecorder.ondataavailable = (e) => audioChunks.push(e.data);
                    mediaRecorder.onstop = () => {
                        const blob = new Blob(audioChunks, { type: 'audio/webm' });
                        audioFile = new File([blob], 'recording.webm', { type: 'audio/webm' });
                        handleFile(audioFile);
                        stream.getTracks().forEach(t => t.stop());
                    };

                    mediaRecorder.start();
                    isRecording = true;
                    document.getElementById('recordBtn').classList.add('recording');
                    document.getElementById('recordBtn').textContent = '‚èπÔ∏è';
                    document.getElementById('recordStatus').textContent = 'Recording... Click to stop';
                } catch (e) {
                    alert('Could not access microphone: ' + e.message);
                }
            } else {
                mediaRecorder.stop();
                isRecording = false;
                document.getElementById('recordBtn').classList.remove('recording');
                document.getElementById('recordBtn').textContent = 'üé§';
                document.getElementById('recordStatus').textContent = 'Click to start recording';
            }
        }

        // API calls
        async function transcribe() {
            if (!audioFile) return alert('Please select an audio file first');
            
            showLoading('Transcribing audio...');
            
            const formData = new FormData();
            formData.append('audio', audioFile);
            formData.append('language', document.getElementById('language').value);
            formData.append('model_size', document.getElementById('modelSize').value);

            try {
                const res = await fetch(`${API_BASE}/api/transcribe-advanced`, {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();
                
                if (data.success) {
                    showResult(`
                        <h3 style="margin-bottom: 15px;">üìù Transcription Result</h3>
                        <p><strong>Language:</strong> ${data.language}</p>
                        <p><strong>Duration:</strong> ${data.duration?.toFixed(2) || 0}s</p>
                        <p><strong>Segments:</strong> ${data.segments?.length || 0}</p>
                        <hr style="border-color: #374151; margin: 15px 0;">
                        <p style="font-size: 1.1rem; line-height: 1.6;">${data.transcript || '(No speech detected)'}</p>
                        ${data.segments?.length ? `<hr style="border-color: #374151; margin: 15px 0;"><h4>Segments:</h4><pre>${JSON.stringify(data.segments, null, 2)}</pre>` : ''}
                    `);
                } else {
                    showResult(`<p style="color: #ef4444;">Error: ${data.error}</p>`);
                }
            } catch (e) {
                showResult(`<p style="color: #ef4444;">Error: ${e.message}</p>`);
            }
        }

        async function diarize() {
            if (!audioFile) return alert('Please select an audio file first');
            
            showLoading('Analyzing speakers...');
            
            const formData = new FormData();
            formData.append('audio', audioFile);
            const numSpeakers = document.getElementById('numSpeakers').value;
            if (numSpeakers) formData.append('num_speakers', numSpeakers);

            try {
                const res = await fetch(`${API_BASE}/api/diarize`, {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();
                
                if (data.success) {
                    let speakersHtml = data.speakers?.map(s => `
                        <div style="margin: 5px 0;">
                            <strong>${s.label}</strong>: ${s.total_time?.toFixed(2)}s (${s.turns} turns)
                        </div>
                    `).join('') || 'No speakers detected';

                    showResult(`
                        <h3 style="margin-bottom: 15px;">üë• Diarization Result</h3>
                        <p><strong>Speakers Found:</strong> ${data.num_speakers}</p>
                        <hr style="border-color: #374151; margin: 15px 0;">
                        <h4>Speaker Summary:</h4>
                        ${speakersHtml}
                        ${data.timeline?.length ? `<hr style="border-color: #374151; margin: 15px 0;"><h4>Timeline:</h4><pre>${JSON.stringify(data.timeline, null, 2)}</pre>` : ''}
                    `);
                } else {
                    showResult(`<p style="color: #ef4444;">Error: ${data.error}</p>`);
                }
            } catch (e) {
                showResult(`<p style="color: #ef4444;">Error: ${e.message}</p>`);
            }
        }

        async function fullPipeline() {
            if (!audioFile) return alert('Please select an audio file first');
            
            // Ask if they want to use queue (async) or direct (sync)
            const useQueue = confirm('Use Queue mode?\n\nYes = Async (recommended for long audio)\nNo = Direct (blocks until complete)');
            
            if (useQueue) {
                await fullPipelineQueued();
            } else {
                await fullPipelineDirect();
            }
        }
        
        async function fullPipelineQueued() {
            showLoading('Submitting to queue...');
            
            const formData = new FormData();
            formData.append('audio', audioFile);
            formData.append('task_type', 'full_pipeline');
            formData.append('language', document.getElementById('language').value);
            formData.append('model_size', document.getElementById('modelSize').value);
            const numSpeakers = document.getElementById('numSpeakers').value;
            if (numSpeakers) formData.append('num_speakers', numSpeakers);

            try {
                // Submit task
                const submitRes = await fetch(`${API_BASE}/api/queue/submit`, {
                    method: 'POST',
                    body: formData
                });
                const submitData = await submitRes.json();
                
                if (!submitData.success) {
                    showResult(`<p style="color: #ef4444;">Error: ${submitData.error}</p>`);
                    return;
                }
                
                const taskId = submitData.task_id;
                console.log('Task submitted:', taskId);
                
                // Poll for status
                await pollTaskStatus(taskId);
                
            } catch (e) {
                showResult(`<p style="color: #ef4444;">Error: ${e.message}</p>`);
            }
        }
        
        async function pollTaskStatus(taskId) {
            const pollInterval = 2000; // 2 seconds
            
            while (true) {
                try {
                    const res = await fetch(`${API_BASE}/api/queue/status/${taskId}`);
                    const data = await res.json();
                    
                    if (data.status === 'completed') {
                        // Get full result
                        const resultRes = await fetch(`${API_BASE}/api/queue/result/${taskId}`);
                        const resultData = await resultRes.json();
                        
                        if (resultData.success) {
                            displayFullPipelineResult(resultData.result);
                        } else {
                            showResult(`<p style="color: #ef4444;">Error: ${resultData.error}</p>`);
                        }
                        return;
                    } else if (data.status === 'failed') {
                        showResult(`<p style="color: #ef4444;">Task failed: ${data.error}</p>`);
                        return;
                    } else if (data.status === 'cancelled') {
                        showResult(`<p style="color: #f59e0b;">Task was cancelled</p>`);
                        return;
                    } else {
                        // Still processing
                        document.getElementById('loadingText').textContent = 
                            `${data.progress_message || 'Processing...'} (${data.progress}%)`;
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, pollInterval));
                } catch (e) {
                    console.error('Poll error:', e);
                    await new Promise(resolve => setTimeout(resolve, pollInterval));
                }
            }
        }
        
        async function fullPipelineDirect() {
            showLoading('Running full pipeline (this may take a while)...');
            
            const formData = new FormData();
            formData.append('audio', audioFile);
            formData.append('language', document.getElementById('language').value);
            formData.append('model_size', document.getElementById('modelSize').value);
            const numSpeakers = document.getElementById('numSpeakers').value;
            if (numSpeakers) formData.append('num_speakers', numSpeakers);

            try {
                const res = await fetch(`${API_BASE}/api/transcribe-with-speakers`, {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();
                
                if (data.success) {
                    displayFullPipelineResult(data);
                } else {
                    showResult(`<p style="color: #ef4444;">Error: ${data.error}</p>`);
                }
            } catch (e) {
                showResult(`<p style="color: #ef4444;">Error: ${e.message}</p>`);
            }
        }
        
        function displayFullPipelineResult(data) {
            let segmentsHtml = data.segments_with_speakers?.map(seg => {
                const speakerNum = parseInt(seg.speaker?.replace('SPEAKER_', '') || '0') % 4;
                return `
                    <div class="speaker-segment speaker-${speakerNum}">
                        <div class="speaker-label">${seg.speaker_label || seg.speaker}</div>
                        <div class="timestamp">${seg.start?.toFixed(2)}s - ${seg.end?.toFixed(2)}s</div>
                        <div style="margin-top: 5px;">${seg.text}</div>
                    </div>
                `;
            }).join('') || '<p>No speech detected</p>';

            let speakersHtml = data.speakers_summary?.map(s => `
                <span style="margin-right: 15px;"><strong>${s.label}:</strong> ${s.total_time?.toFixed(1)}s</span>
            `).join('') || '';

            showResult(`
                <h3 style="margin-bottom: 15px;">üöÄ Full Pipeline Result</h3>
                <p><strong>Language:</strong> ${data.language} | <strong>Speakers:</strong> ${data.num_speakers} | <strong>Duration:</strong> ${data.duration?.toFixed(2) || 0}s</p>
                <p style="margin-top: 10px;">${speakersHtml}</p>
                <hr style="border-color: #374151; margin: 15px 0;">
                <h4>Transcript with Speakers:</h4>
                ${segmentsHtml}
            `);
        }

        function showLoading(text) {
            document.getElementById('loading').classList.add('active');
            document.getElementById('loadingText').textContent = text;
            document.getElementById('resultBox').style.display = 'none';
        }

        function showResult(html) {
            document.getElementById('loading').classList.remove('active');
            document.getElementById('resultBox').style.display = 'block';
            document.getElementById('resultContent').innerHTML = html;
        }

        // Init
        checkServer();
        setInterval(checkServer, 30000);
    </script>
</body>
</html>
